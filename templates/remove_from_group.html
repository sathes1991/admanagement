{% extends "base.html" %}

{% block title %}Remove from Group - AD Manager{% endblock %}

{% block extra_head %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="dashboard-card">
                <div class="d-flex align-items-center mb-4">
                    <div class="card-icon me-3" style="background: rgba(220, 53, 69, 0.1); color: var(--danger-color);">
                        <i class="fas fa-user-minus"></i>
                    </div>
                    <div>
                        <h1 class="h3 mb-0">Remove User from Group</h1>
                        <p class="text-muted mb-0">Remove users from Active Directory groups</p>
                    </div>
                </div>

                <form method="POST" id="removeFromGroupForm">
                    <div class="row g-4">
                        <!-- User Selection -->
                        <div class="col-md-6">
                            <label for="user" class="form-label">
                                <i class="fas fa-user"></i> Select User <span class="text-danger">*</span>
                            </label>
                            <select name="user" id="user" class="form-select" required>
                                <option value="">Choose a user...</option>
                                {% for user in users %}
                                <option value="{{ user }}">{{ user }}</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Search by typing the username</small>
                        </div>

                        <!-- Group Selection -->
                        <div class="col-md-6">
                            <label for="group" class="form-label">
                                <i class="fas fa-users"></i> Select Group <span class="text-danger">*</span>
                            </label>
                            <select name="group" id="group" class="form-select" required>
                                <option value="">Choose a group...</option>
                                {% for group in groups %}
                                <option value="{{ group }}">{{ group }}</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Choose the group to remove from</small>
                        </div>
                    </div>

                    <!-- Warning Section -->
                    <div class="warning-section mt-4" style="display: none;">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <span id="warningText">Select both user and group to see preview</span>
                        </div>
                    </div>

                    <!-- Current Group Memberships -->
                    <div class="current-groups-section mt-4" style="display: none;">
                        <h6 class="text-muted mb-3"><i class="fas fa-users-cog"></i> Current Group Memberships</h6>
                        <div id="currentGroupsList" class="current-groups-grid">
                            <!-- Groups will be loaded here via JavaScript -->
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('group_members') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Back
                        </a>
                        <button type="submit" class="btn btn-danger" disabled onclick="return confirmRemoval();">
                            <i class="fas fa-user-minus"></i> Remove from Group
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
.warning-section {
    background: #fff3cd;
    padding: 20px;
    border-radius: 8px;
}

.current-groups-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
}

.group-badge {
    display: inline-flex;
    align-items: center;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 20px;
    padding: 5px 15px;
    font-size: 14px;
}

.group-badge.target {
    background: #f8d7da;
    border-color: #dc3545;
    color: #dc3545;
}

.group-badge.other {
    background: #e7f3ff;
    border-color: #0066cc;
    color: #0066cc;
}

.select2-container--bootstrap-5 .select2-selection {
    min-height: calc(1.5em + 0.75rem + 2px);
}
</style>
{% endblock %}

{% block extra_scripts %}
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
let selectedUser = '';
let selectedGroup = '';

$(document).ready(function() {
    // Initialize Select2
    $('#user, #group').select2({
        theme: 'bootstrap-5',
        width: '100%'
    });

    // Enable/disable submit button
    function updateSubmitButton() {
        selectedUser = $('#user').val();
        selectedGroup = $('#group').val();
        const submitBtn = $('button[type="submit"]');
        
        if (selectedUser && selectedGroup) {
            submitBtn.prop('disabled', false);
            updateWarning(selectedUser, selectedGroup);
        } else {
            submitBtn.prop('disabled', true);
            $('.warning-section').hide();
        }
    }

    // Update warning
    function updateWarning(user, group) {
        $('.warning-section').show();
        $('#warningText').html(`⚠️ User <strong>${user}</strong> will be removed from group <strong>${group}</strong>. This action cannot be undone.`);
    }

    // Mock function to show current groups
    function loadUserGroups(username, targetGroup) {
        if (username) {
            $('.current-groups-section').show();
            // This is mock data - in real implementation, fetch from server
            const mockGroups = ['Domain Users', 'LinuxAdmins', 'Developers'];
            let html = '';
            mockGroups.forEach(group => {
                if (group === targetGroup) {
                    html += `<span class="group-badge target"><i class="fas fa-times-circle me-2"></i>${group} (will be removed)</span>`;
                } else {
                    html += `<span class="group-badge other"><i class="fas fa-users me-2"></i>${group}</span>`;
                }
            });
            $('#currentGroupsList').html(html);
        } else {
            $('.current-groups-section').hide();
        }
    }

    // Event handlers
    $('#user, #group').on('change', function() {
        updateSubmitButton();
        if ($('#user').val() && $('#group').val()) {
            loadUserGroups($('#user').val(), $('#group').val());
        }
    });
});

// Confirm removal
function confirmRemoval() {
    return confirm(`Are you sure you want to remove ${selectedUser} from ${selectedGroup}?`);
}
</script>
{% endblock %}